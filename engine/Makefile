#!make -f
#
# This software is licensed under the GNU General Public License.
# Please, see LICENSE.TXT for further information.
#

#
# gcc >= 2.95.3 (sparemint) version
#

TARGET = fvdi_gnu.prg

all: $(TARGET)

top_srcdir = ..
srcdir     = .

include $(top_srcdir)/CONFIGVARS

ifneq ($(stdlib_srcdir),)
 STDLIB_CFLAGS = -I$(stdlib_srcdir)/include
else
 STDLIB_CFLAGS = -I$(top_srcdir)/modules/include
endif

CFLAGS  = $(CPUSWITCH) $(OPTS) $(WARNINGS) -I$(top_srcdir)/include $(STDLIB_CFLAGS)
ASFLAGS = $(CPUSWITCH) -I$(top_srcdir)/include -I$(top_srcdir)/drivers/include -I$(top_srcdir)/drivers/1_plane

LDFLAGS = -s --mprg-flags=0x27

# FreeType2 things
ifneq ($(ft2_srcdir),)
 ifneq ($(libkern_srcdir),)
  ifeq ($(CPU),020))
    LIBKERN_NAME=kern020-60
  else
    ifeq ($(CPU),coldfire))
      LIBKERN_NAME=kernv4e
    else
      LIBKERN_NAME=kern$(CPU)
    endif
  endif
  LIBKERN = $(libkern_srcdir)/$(LIBKERN_NAME).a
  LIBS   := -lft2 -l$(LIBKERN_NAME) $(LIBS)
  LDFLAGS += -L$(top_srcdir)/modules/ft2 -L$(libkern_srcdir)
  CFLAGS += -DUSE_LIBKERN
 else
  LIBKERN = 
  LIBS   := -lft2 $(LIBS)
  LDFLAGS += -L$(top_srcdir)/modules/ft2
 endif

 LIBFT2  = $(top_srcdir)/modules/ft2/libft2.a
 LIBFILES= $(LIBFT2) $(LIBKERN)
 CFLAGS += -DFT2 -I$(top_srcdir)/modules/ft2/include $(FT2_DEBUG_OPTS) \
           -I$(ft2_srcdir)/include 
endif


SINCSRC = \
	$(top_srcdir)/include/macros.inc \
	$(top_srcdir)/include/types.inc \
	$(top_srcdir)/include/vdi.inc \
	$(top_srcdir)/drivers/include/linea.inc \
	$(top_srcdir)/drivers/include/pixelmac.inc \
	$(top_srcdir)/drivers/1_plane/1_expand.inc

SSRC = \
	fvdi.s \
	blit.s \
	colours.s \
	draw.s \
	expand.s \
	fill_sq.s \
	gnu.s \
	line_sq.s \
	mark_sq.s \
	mouse.s \
	simple.s \
	support.s \
	sys_call.s \
	textrndr.s \
	text.s \
	text_sq.s \
	traptabl.s \
	unimpl.s \
	vdi_misc.s \
	dcsdstub.s \
	bconstub.s \
	setjmp.s


CSRC = \
	startup.c \
	utility.c \
	bezier.c \
	conic.c \
	escape.c \
	fonts.c \
	line.c \
	loader.c \
	math.c \
	patterns.c \
	polygon.c \
	setup.c \
	workstn.c \
	colour.c \
	textlib.c \
	calamus.c \
	bconout.c \
	default.c

ifneq ($(ft2_srcdir),)
 CSRC+= \
	$(top_srcdir)/modules/ft2/ft2.c \
	$(top_srcdir)/modules/ft2/atari2unicode.c \
	$(top_srcdir)/modules/ft2/atari2bics.c \
	$(top_srcdir)/modules/ft2/bics2unicode.c \
	$(top_srcdir)/modules/ft2/ft2_ftsystem.c

 ifeq ($(DEBUG),yes)
  CSRC+= \
	$(top_srcdir)/modules/ft2/ft2_ftdebug.c
 endif
endif

# Handle DevPac -> gas conversions
# Defines SSRC_GNU and SINCSRC_GNU variables
include $(top_srcdir)/utility/conv2gas/RULES

# Need to convert the .inc files as well
$(SSRC_GNU): $(SINCSRC_GNU)

# Engine binary objects
OBJECTS = $(SSRC_GNU:.gnu=.gnu.o) $(CSRC:.c=.o)

# libkern + stdlib additions
ifneq ($(stdlib_srcdir),)
 CLIBSRC = \
	$(stdlib_srcdir)/qsort.c \
	$(stdlib_srcdir)/msort.c \
	$(stdlib_srcdir)/mempcpy.c \
	$(stdlib_srcdir)/strdup.c

 SLIBSRC = \
	$(stdlib_srcdir)/setjmp.S

 OBJECTS+= $(CLIBSRC:.c=.o) $(SLIBSRC:.S=.S.o)
endif

%.S.o: %.S
	$(AM_V_AS)$(CC) $(ASFLAGS) -Dgas=1 -Dlattice=0 -o $@ -c $<

$(LIBKERN):
	$(MAKE) -C $(libkern_srcdir)

$(LIBFT2):
	$(MAKE) -C $(top_srcdir)/modules/ft2

$(TARGET): depend $(OBJECTS) $(LIBFILES)
	$(AM_V_LD)$(LD) -o $@ -Map=fvdi.map $(OBJECTS) $(LDFLAGS) $(LIBS)
	@ls -l $@

$(top_srcdir)/include/types.inc: $(top_srcdir)/include/fvdi.h
	$(MAKE) -C $(top_srcdir)/utility/structer
	$(AM_V_GEN)(echo "*****"; \
	  echo "* fVDI structure declarations, by Johan Klockars"; \
	  echo "*"; \
	  echo "* \$$Id\$$"; \
	  echo "*"; \
	  echo "* GENERATED AUTOMATICALLY by structer from fvdi.h"; \
	  echo "* -- DO NOT EDIT --"; \
	  echo "*"; \
	  echo "* This is auto-generated by the Makefile from fvdi.h using"; \
	  echo "*  gcc -E -DANONYMOUS fvdi.h | structer Virtual=vwk Workstation=wk \\"; \
	  echo "*  Fontheader=font MFDB=mfdb Colour=colour RGB=rgb List=list \\"; \
	  echo "*  Driver=driver Mouse=mouse Device=dev DrvLine=drvline \\"; \
	  echo "*  DrvPalette=drvpalette > types.inc"; \
	  echo "*"; \
	  echo "* Most assembly files in the fVDI engine, as well as in its"; \
	  echo "* device drivers, need to include this file."; \
	  echo "*"; \
	  echo "* Since it would be difficult to do without this file when"; \
	  echo "* writing new device drivers, and to make it possible for"; \
	  echo "* some such drivers to be commercial, this file is put in"; \
	  echo "* the public domain. It is not copyrighted or under any sort"; \
	  echo "* of license."; \
	  echo "*****"; \
	  echo ; \
	) > $@
	$(AM_V_at)$(CC) -E -DANONYMOUS $(top_srcdir)/include/fvdi.h | \
	  $(top_srcdir)/utility/structer/structer \
	  Virtual=vwk Workstation=wk Fontheader=font MFDB=mfdb \
	  Colour=colour RGB=rgb List=list Driver=driver \
	  Mouse=mouse Device=dev DrvLine=drvline DrvPalette=drvpalette \
	  v_bez_pars=v_bez_pars \
	  >> $@ || { $(RM) $@; exit 1; }

depend: $(CSRC)
#	"$(CC) -MM" does not seem able to keep track of the directory of the
#	object file, so dependencies of files outside this directory are
#	never taken into account later. makedepend does this correctly.
#	Unfortunately, makedepend includes system headers in its
#	dependency lists, but you can't get everything...
#	$(CC) -MM $(CFLAGS) $(CSRC) > depend
	$(AM_V_at)makedepend -f- -- $(CFLAGS) $(CSRC) > depend 2> /dev/null
	$(AM_V_at)sed "s#\/usr[^ ]*\.h##g" < depend  > depend2
	$(AM_V_at)sed "s#^.*: *\$$##"      < depend2 > depend
	$(AM_V_at)$(RM) depend2

clean: clean_gnu
	$(RM) $(OBJECTS) fvdi.map depend

mrproper:
	$(MAKE) clean
	$(MAKE) -C $(top_srcdir)/modules/ft2 clean

-include depend
